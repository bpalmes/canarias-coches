// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------
// ENUMS
// -----------------------------------------------------

enum Role {
  SUPER_ADMIN // Platform owner: sees all dealerships
  DEALERSHIP_ADMIN // Admin of a specific dealership
  DEALERSHIP_USER // Staff of a specific dealership
  CUSTOMER // Registered buyer (optional for now)
}

enum DealershipType {
  OFFICIAL // Oficial Dealer
  MULTIBRAND // Compraventa generico
  PRIVATE // Particular (future use)
}

enum CarStatus {
  DRAFT
  PUBLISHED
  RESERVED
  SOLD
}

enum LeadStatus {
  NEW
  CONTACTED
  VISIT_SCHEDULED
  OFFER_SENT
  WON
  LOST
}

// -----------------------------------------------------
// CORE TENANCY (Multi-tenant)
// -----------------------------------------------------

model Dealership {
  id   Int            @id @default(autoincrement())
  slug String         @unique // for URLs: canarias-coches.com/dealership-slug
  name String
  type DealershipType @default(MULTIBRAND)

  // Contact & Location
  email   String?
  phone   String?
  address String?
  city    String?
  logoUrl String?
  website String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users User[]
  cars  Car[]
  leads Lead[]
  financingConditions FinancingCondition[]
  financingRequests FinancingRequest[]
}

model User {
  id       Int     @id @default(autoincrement())
  email    String  @unique
  password String
  name     String?
  role     Role    @default(DEALERSHIP_USER)

  // Multi-tenancy
  dealership   Dealership? @relation(fields: [dealershipId], references: [id])
  dealershipId Int? // Null for SUPER_ADMIN, Required for others

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -----------------------------------------------------
// VEHICLE NORMALIZATION (3NF)
// -----------------------------------------------------

model Make {
  id     Int     @id @default(autoincrement())
  name   String  @unique // e.g., "Toyota"
  models Model[]
  active Boolean @default(true)
  Car    Car[]
}

model Model {
  id     Int    @id @default(autoincrement())
  name   String // e.g., "Corolla"
  make   Make   @relation(fields: [makeId], references: [id])
  makeId Int
  cars   Car[]

  @@unique([makeId, name]) // Unique model name per make
}

// -----------------------------------------------------
// INVENTORY
// -----------------------------------------------------

model Car {
  id Int @id @default(autoincrement())

  // Multi-tenancy
  dealership   Dealership @relation(fields: [dealershipId], references: [id])
  dealershipId Int

  // Core ID
  sku String? // Dealer internal ref
  name String? // Display title
  vin String? // @unique logic removed temporarily to allow drafts without VIN or duplicate potential checks

  // Normalized Details
  make    Make  @relation(fields: [makeId], references: [id])
  makeId  Int
  model   Model @relation(fields: [modelId], references: [id])
  modelId Int

  version String? // Free text for specific version detail "2.0 TDI Sport"

  // Pricing
  price               Float
  financedPrice       Float?
  monthlyFinancingFee Float?
  vatDeductible       Boolean @default(false)

  // Specs
  bodytype     String?
  year         Int
  month        Int?
  kms          Int
  fuel         String? // Could be Enum or Normalized later
  power        Int? // CV
  transmission String? // Manual/Auto
  color        String?
  doors        Int?
  seats        Int?
  engineSize   Int? // cc
  gears        Int?

  // Location (Overrides Dealership default if needed)
  store   String?
  city    String?
  address String?

  // Additional Info
  numberplate        String?
  guarantee          String?
  environmentalBadge String?
  crashed            Boolean @default(false)

  // Status
  status CarStatus @default(DRAFT)
  isSold Boolean   @default(false) // Keep for backward compat logic, sync with status

  // Content
  description String? @db.Text
  equipment   String? @db.Text

  // B2B Marketplace
  isB2BAvailable Boolean @default(false)
  b2bPrice       Float? // Price for other dealers

  // Metadata
  source      String?  @default("manual") // 'feed', 'manual', 'xml'

  // Images
  images Image[]

  // Relations
  leads  Lead[]
  offers Offer[] @relation("CarToOffer")
  financingRequests FinancingRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Image {
  id        Int     @id @default(autoincrement())
  url       String
  car       Car     @relation(fields: [carId], references: [id], onDelete: Cascade)
  carId     Int
  isPrimary Boolean @default(false)
  order     Int     @default(0)
  source    String  @default("feed")
}

// -----------------------------------------------------
// MARKETING & SALES
// -----------------------------------------------------

model Offer {
  id          Int     @id @default(autoincrement())
  title       String
  slug        String  @unique
  description String?
  cars        Car[]   @relation("CarToOffer")

  // Visuals
  bannerImageUrl String?

  // TÃ­tulos personalizados
  offerTitle    String?
  offerSubtitle String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FinancingCondition {
  id            Int        @id @default(autoincrement())
  dealership    Dealership @relation(fields: [dealershipId], references: [id])
  dealershipId  Int

  name          String     // e.g. "Standard Bank Campaign"
  interestRate  Float      // TIN e.g. 5.99
  minEntry      Float?     // Minimum down payment (percentage or fixed, handled by logic)
  openingFee    Float?     // Apertura %
  
  minTerm       Int        @default(12) // months
  maxTerm       Int        @default(120) // months
  
  isActive      Boolean    @default(true)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}


model Lead {
  id String @id @default(cuid())

  // Multi-tenancy
  dealership   Dealership? @relation(fields: [dealershipId], references: [id])
  dealershipId Int? // Null if it's a general platform lead not assigned yet (rare)

  // Customer Info
  firstName String
  lastName  String?
  email     String
  phone     String?
  message   String?

  // Interest
  car   Car? @relation(fields: [carId], references: [id])
  carId Int?

  status LeadStatus @default(NEW)
  source String? // website, facebook, walcu

  // CRM External IDs
  walcuLeadId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dealershipId])
  @@index([email])
  
  financingRequest FinancingRequest?
}

model FinancingRequest {
  id String @id @default(cuid())

  // Tenancy
  dealership   Dealership @relation(fields: [dealershipId], references: [id])
  dealershipId Int

  // Relation to Lead (Customer) & Car
  lead   Lead @relation(fields: [leadId], references: [id])
  leadId String @unique // One financing request tracked per lead for simplicity
  
  car    Car @relation(fields: [carId], references: [id])
  carId  Int

  // Financial details
  amount        Float
  term          Int
  downPayment   Float @default(0)
  monthlyFee    Float?

  // Genesis / External Info
  genesisId     String? // ID in external ERP
  genesisStatus String? // Status in external ERP

  // System Status
  status        FinancingStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum FinancingStatus {
  PENDING
  PROCESSING
  APPROVED
  REJECTED
  FUNDED
}

model GalleryImage {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  imageUrl    String
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("gallery_images")
}
