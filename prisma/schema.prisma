// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------
// ENUMS
// -----------------------------------------------------

enum Role {
  SUPER_ADMIN // Platform owner: sees all dealerships
  DEALERSHIP_ADMIN // Admin of a specific dealership
  DEALERSHIP_USER // Staff of a specific dealership
  CUSTOMER // Registered buyer (optional for now)
}

enum DealershipType {
  OFFICIAL // Oficial Dealer
  MULTIBRAND // Compraventa generico
  PRIVATE // Particular (future use)
}

enum CarStatus {
  DRAFT
  PUBLISHED
  RESERVED
  SOLD
}

enum LeadStatus {
  NEW
  CONTACTED
  VISIT_SCHEDULED
  OFFER_SENT
  WON
  LOST
}

// -----------------------------------------------------
// CORE TENANCY (Multi-tenant)
// -----------------------------------------------------

model Dealership {
  id   Int            @id @default(autoincrement())
  slug String         @unique // for URLs: canarias-coches.com/dealership-slug
  name String
  type DealershipType @default(MULTIBRAND)

  // Contact & Location
  email   String?
  phone   String?
  address String?
  city    String?
  logoUrl String?
  website String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users User[]
  cars  Car[]
  leads Lead[]
  financingConditions FinancingCondition[]
  financingRequests FinancingRequest[]
  
  // Financing Configuration
  financingEnabled      Boolean @default(false)
  usePlatformFinancing  Boolean @default(false)
  
  // Granular Financing Controls
  enableWithInsurance    Boolean @default(true)
  enableWithoutInsurance Boolean @default(true)
  
  enabledFinancialEntities FinancialEntity[]
  enabledInterestRates     FinancialInterestRate[]
  
  // B2B Relations
  b2bSales    B2BRequest[] @relation("B2BSeller")
  b2bPurchases B2BRequest[] @relation("B2BBuyer")
}

model User {
  id       Int     @id @default(autoincrement())
  email    String  @unique
  password String
  name     String?
  role     Role    @default(DEALERSHIP_USER)

  // Multi-tenancy
  dealership   Dealership? @relation(fields: [dealershipId], references: [id])
  dealershipId Int? // Null for SUPER_ADMIN, Required for others

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -----------------------------------------------------
// VEHICLE NORMALIZATION (3NF)
// -----------------------------------------------------

model Make {
  id     Int     @id @default(autoincrement())
  name   String  @unique // e.g., "Toyota"
  models Model[]
  active Boolean @default(true)
  Car    Car[]
}

model Model {
  id     Int    @id @default(autoincrement())
  name   String // e.g., "Corolla"
  make   Make   @relation(fields: [makeId], references: [id])
  makeId Int
  cars   Car[]

  @@unique([makeId, name]) // Unique model name per make
}

// -----------------------------------------------------
// INVENTORY
// -----------------------------------------------------

model Car {
  id Int @id @default(autoincrement())

  // Multi-tenancy
  dealership   Dealership @relation(fields: [dealershipId], references: [id])
  dealershipId Int

  // Core ID
  sku String? // Dealer internal ref
  name String? // Display title
  vin String? // @unique logic removed temporarily to allow drafts without VIN or duplicate potential checks

  // Normalized Details
  make    Make  @relation(fields: [makeId], references: [id])
  makeId  Int
  model   Model @relation(fields: [modelId], references: [id])
  modelId Int

  version String? // Free text for specific version detail "2.0 TDI Sport"

  // Pricing
  price               Float
  financedPrice       Float?
  monthlyFinancingFee Float?
  financeMinInstallment Float? // Calculated minimum installment
  financeMinInstallmentSS Float? // Calculated minimum installment (Sin Seguro)
  vatDeductible       Boolean @default(false)

  // Specs
  bodytype     String?
  year         Int
  month        Int?
  kms          Int
  fuel         String? // Could be Enum or Normalized later
  power        Int? // CV
  transmission String? // Manual/Auto
  color        String?
  doors        Int?
  seats        Int?
  engineSize   Int? // cc
  gears        Int?

  // Location (Overrides Dealership default if needed)
  store   String?
  city    String?
  address String?

  // Additional Info
  numberplate        String?
  guarantee          String?
  environmentalBadge String?
  crashed            Boolean @default(false)

  // Status
  status CarStatus @default(DRAFT)
  isSold Boolean   @default(false) // Keep for backward compat logic, sync with status

  // Content
  description String? @db.Text
  equipment   String? @db.Text

  // B2B Marketplace
  isB2BAvailable Boolean @default(false)
  b2bPrice       Float? // Price for other dealers

  // Metadata
  source      String?  @default("manual") // 'feed', 'manual', 'xml'

  // Images
  images Image[]

  // Relations
  leads  Lead[]
  offers Offer[] @relation("CarToOffer")
  financingRequests FinancingRequest[]
  b2bRequests B2BRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Image {
  id        Int     @id @default(autoincrement())
  url       String
  car       Car     @relation(fields: [carId], references: [id], onDelete: Cascade)
  carId     Int
  isPrimary Boolean @default(false)
  order     Int     @default(0)
  source    String  @default("feed")
}

// -----------------------------------------------------
// MARKETING & SALES
// -----------------------------------------------------

model Offer {
  id          Int     @id @default(autoincrement())
  title       String
  slug        String  @unique
  description String?
  cars        Car[]   @relation("CarToOffer")

  // Visuals
  bannerImageUrl String?

  // Títulos personalizados
  offerTitle    String?
  offerSubtitle String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FinancingCondition {
  id            Int        @id @default(autoincrement())
  dealership    Dealership @relation(fields: [dealershipId], references: [id])
  dealershipId  Int

  name          String     // e.g. "Standard Bank Campaign"
  interestRate  Float      // TIN e.g. 5.99
  minEntry      Float?     // Minimum down payment (percentage or fixed, handled by logic)
  openingFee    Float?     // Apertura %
  
  minTerm       Int        @default(12) // months
  maxTerm       Int        @default(120) // months
  
  isActive      Boolean    @default(true)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}


model Lead {
  id String @id @default(cuid())

  // Multi-tenancy
  dealership   Dealership? @relation(fields: [dealershipId], references: [id])
  dealershipId Int? // Null if it's a general platform lead not assigned yet (rare)

  // Customer Info
  firstName String
  lastName  String?
  email     String
  phone     String?
  message   String?

  // Interest
  car   Car? @relation(fields: [carId], references: [id])
  carId Int?

  status LeadStatus @default(NEW)
  source String? // website, facebook, walcu

  // CRM External IDs
  walcuLeadId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dealershipId])
  @@index([email])
  
  financingRequest FinancingRequest?
}

model FinancingRequest {
  id String @id @default(cuid())

  // Tenancy
  dealership   Dealership @relation(fields: [dealershipId], references: [id])
  dealershipId Int

  // Relation to Lead (Customer) & Car
  lead   Lead @relation(fields: [leadId], references: [id])
  leadId String @unique // One financing request tracked per lead for simplicity
  
  car    Car @relation(fields: [carId], references: [id])
  carId  Int

  // Financial details
  amount        Float
  term          Int
  downPayment   Float @default(0)
  monthlyFee    Float?

  // Genesis / External Info
  genesisId     String? // ID in external ERP
  genesisStatus String? // Status in external ERP

  // System Status
  status        FinancingStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum FinancingStatus {
  PENDING
  PROCESSING
  APPROVED
  REJECTED
  FUNDED
}

model GalleryImage {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  imageUrl    String
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("gallery_images")
}


model B2BRequest {
  id        String   @id @default(cuid())
  
  // The Seller (Owner of the car)
  sellerId  Int
  seller    Dealership @relation("B2BSeller", fields: [sellerId], references: [id])

  // The Buyer (Dealership requesting)
  buyerId   Int
  buyer     Dealership @relation("B2BBuyer", fields: [buyerId], references: [id])

  // The Car
  carId     Int
  car       Car      @relation(fields: [carId], references: [id])

  status    String   @default("PENDING") // PENDING, ACCEPTED, REJECTED
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -----------------------------------------------------
// FINANCIAL CALCULATOR MODULE (System V2)
// -----------------------------------------------------

model FinancialEntity {
  id             Int       @id @default(autoincrement())
  name           String    // 'Santander Consumer Finance'
  code           String    // 'SANTANDER'
  description    String?   @db.Text
  logo           String?   // URL
  isActive       Boolean   @default(true)
  organizationId Int?      // For multi-tenant override if needed (NULL = global)
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @default(now()) @updatedAt

  configurations FinancialEntityConfiguration[]
  dealerships    Dealership[]

  @@index([organizationId, isActive])
  @@map("financial_entities")
}

model FinancialInterestRate {
  id        Int      @id @default(autoincrement())
  name      String   // '5,99%', '6,99%'
  value     Decimal  @db.Decimal(5, 2) // 5.99
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  details FinancialConfigurationDetail[]
  dealerships Dealership[]

  @@map("financial_interest_rates")
}

model FinancialLoanTerm {
  id             Int      @id @default(autoincrement())
  name           String   // '60 meses'
  durationMonths Int      @unique // 60
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @default(now()) @updatedAt

  details FinancialConfigurationDetail[]

  @@map("financial_loan_terms")
}

model FinancialCampaign {
  id                   Int      @id @default(autoincrement())
  name                 String   // 'Vehículos Nuevos'
  code                 String   @unique // 'vn', 'vo'
  minVehiculoAgeMonths Int?     // 0 for VN
  maxVehiculoAgeMonths Int?     // 12 for VN, NULL for VO
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @default(now()) @updatedAt

  details FinancialConfigurationDetail[]

  @@map("financial_campaigns")
}

model FinancialEntityConfiguration {
  id              Int       @id @default(autoincrement())
  entityId        Int
  entity          FinancialEntity @relation(fields: [entityId], references: [id])
  
  name            String    // 'Configuración Laravel Santander'
  version         Int       @default(1)
  parentId        Int?      // For version history
  isLive          Boolean   @default(false)
  publishedAt     DateTime?
  userIdPublisher Int?
  priority        Int       @default(0)
  isActive        Boolean   @default(true)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @default(now()) @updatedAt

  details FinancialConfigurationDetail[]
  rules   FinancialConfigurationRule[]
  audit   FinancialAuditTrail[]

  @@index([entityId, isLive])
  @@map("financial_entity_configurations")
}

model FinancialConfigurationDetail {
  id              Int @id @default(autoincrement())
  
  configurationId Int
  configuration   FinancialEntityConfiguration @relation(fields: [configurationId], references: [id])

  campaignId      Int
  campaign        FinancialCampaign @relation(fields: [campaignId], references: [id])

  interestRateId  Int
  interestRate    FinancialInterestRate @relation(fields: [interestRateId], references: [id])

  loanTermId      Int
  loanTerm        FinancialLoanTerm @relation(fields: [loanTermId], references: [id])

  // CALCULATION
  calculationType String // 'coeficiente' or 'rentabilidad'
  value           Decimal @db.Decimal(10, 6) // 3.269800

  // OPTIONAL RANGES
  minLoanAmount        Decimal? @db.Decimal(12, 2)
  maxLoanAmount        Decimal? @db.Decimal(12, 2)
  minVehiculoAgeMonths Int?
  maxVehiculoAgeMonths Int?

  // COMMISSIONS
  openingCommissionPercentage Decimal? @db.Decimal(5, 2)
  openingCommissionFixed      Decimal? @db.Decimal(10, 2)
  studyCommissionPercentage   Decimal? @db.Decimal(5, 2)
  studyCommissionFixed        Decimal? @db.Decimal(10, 2)
  otherFees                   Json?

  isActive Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([configurationId, campaignId, interestRateId, loanTermId, calculationType], name: "unique_config_detail")
  @@index([configurationId, campaignId, interestRateId, loanTermId])
  @@index([calculationType, isActive])
  @@map("financial_configuration_details")
}

model FinancialConfigurationRule {
  id              Int @id @default(autoincrement())
  configurationId Int
  configuration   FinancialEntityConfiguration @relation(fields: [configurationId], references: [id])

  parameterType String // 'vehiculo_age_months', 'loan_amount'
  operator      String // '>', '<', '<=', '>=', '=', '!=', 'between'
  value1        String
  value2        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@map("financial_configuration_rules")
}

model FinancialAuditTrail {
  id              Int @id @default(autoincrement())
  configurationId Int
  configuration   FinancialEntityConfiguration @relation(fields: [configurationId], references: [id])

  userId      Int?
  action      String // 'created', 'updated', 'deleted', 'published'
  oldValues   Json?
  newValues   Json?
  description String? @db.Text
  metadata    Json?
  
  createdAt DateTime @default(now())

  @@map("financial_audit_trails")
}

model FinancialCalculationLog {
  id String @id @default(uuid())

  organizationId Int
  userId         Int?

  input       Json
  results     Json
  resultCount Int
  
  bestMonthlyPayment Decimal? @db.Decimal(10, 2)
  bestTAE            Decimal? @db.Decimal(5, 2)

  calculationMethod  String // 'french_amortization'
  processingTimeMs   Int
  calculationMetadata Json?

  clientIP  String?
  userAgent String?
  sessionId String?

  vehiculoCategory    String?
  priceCategory       String?
  requestedLoanAmount Decimal? @db.Decimal(10, 2)
  requestedTermMonths Int?
  requestedRate       Decimal? @db.Decimal(5, 2)
  requestedGuarantees String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([organizationId, createdAt])
  @@index([userId, createdAt])
  @@map("financial_calculation_logs")
}
